<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport"
		content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
	<title>Godot Engine Web Editor (4.2.2.stable.custom_build)</title>
	<style>
		*:focus {
			outline: none;
			background-color: black;
		}

		#canvas,
		#gameCanvas {
			display: block;
			margin: 0;
			color: white;
		}
	</style>
</head>

<body>
	<div id="tabs">
		<div id="tab-loader">
		</div>
		<div id="tab-editor" style="display: none;">
		</div>
		<div id="tab-game" style="display: none;">
			<canvas id="game-canvas" tabindex="2">
			</canvas>
		</div>
		<div id="tab-status" style="display: none;">
			<canvas id="editor-canvas" tabindex="1">
			</canvas>
		</div>
	</div>
	<script src="godot.editor.js"></script>
	<script>
		window.addEventListener('load', () => {
			if ('serviceWorker' in navigator) {
				navigator.serviceWorker.register('service.worker.js').then(function (reg) {
					if (reg.waiting) {
						notifyUpdate(reg.waiting);
					}
					reg.addEventListener('updatefound', function () {
						const update = reg.installing;
						update.addEventListener('statechange', function () {
							if (update.state === 'installed') {
								// It's a new install, claim and perform aggressive caching.
								if (!reg.active) {
									update.postMessage('claim');
								} else {
									notifyUpdate(update);
								}
							}
						});
					});
				});
			}

			runGame();
		});

		let editor = null;
		let game = null;
		let setStatusMode;
		let setStatusNotice;
		let video_driver = '';
		var editorExitCount = 0
		const INDETERMINATE_STATUS_STEP_MS = 100;
		const persistentPaths = ['/home/web_user'];
		const tabs = [
			document.getElementById('tab-loader'),
			document.getElementById('tab-editor'),
			document.getElementById('tab-game'),
		];

		let editorCanvas = document.getElementById('editor-canvas');
		let gameCanvas = document.getElementById('game-canvas');

		let initializing = true;
		let statusMode = 'hidden';
		let lastScale = 0;
		let lastWidth = 0;
		let lastHeight = 0;
		let OnEditorExit = function () {
			showTab('loader');
		};
		const editorConfig = {
			'unloadAfterInit': false,
			'canvas': editorCanvas,
			'canvasResizePolicy': 0,
			'onExit': function () {
				editorExitCount++
				editorCanvas = replaceCanvas(editorCanvas);
				if (OnEditorExit) {
					OnEditorExit();
				}
				if (editorExitCount == 2) {
					console.log("Start game")
					ExecuteGame()
				}
			},
			'onExecute': ImportProject,
			'persistentPaths': persistentPaths,
		};
		async function runGame() {
			const zipResp = fetch('/game.zip')
			const zipData = await (await (zipResp)).arrayBuffer()
			console.log("Load data succ 4", zipData)
			InstallAndRunGame(zipData);
		};

		function showTab(name) {
			tabs.forEach(function (elem) {
				if (elem.id === `tab-${name}`) {
					elem.style.display = 'block';
					if (name === 'editor' || name === 'game') {
						const canvas = document.getElementById(`${name}-canvas`);
						canvas.focus();
					}
				} else {
					elem.style.display = 'none';
				}
			});
		}



		function ExecuteGame() {
			args = [
				"--path",
				"/home/web_user/Preload",
				"--editor-pid",
				"0",
				"res://main.tscn"
			]
			const gameConfig = {
				'persistentPaths': persistentPaths,
				'unloadAfterInit': false,
				'canvas': gameCanvas,
				'canvasResizePolicy': 1,
				'onExit': function () {
					gameCanvas = replaceCanvas(gameCanvas);
					showTab('editor');
					game = null;
				},
			};
			if (game) {
				console.error('A game is already running. Close it first');
				return;
			}
			gameCanvas = replaceCanvas(gameCanvas);
			game = new Engine(gameConfig);
			showTab('game');
			game.init('godot.editor').then(function () {
				requestAnimationFrame(function () {
					game.start({ 'args': args, 'canvas': gameCanvas }).then(function () {
						gameCanvas.focus();
					});
				});
			});
		}
		function ImportProject(args) {
			// import projects
			console.log("Execute ==== ", args)
			const is_project_manager = args.filter(function (v) {
				return v === '--project-manager';
			}).length !== 0;
			if (video_driver) {
				args.push('--rendering-driver', video_driver);
			}
			OnEditorExit = function (code) {
				editor.init().then(function () {
					OnEditorExit = function () {
						showTab('loader');
					};
					editor.start({ 'args': args, 'persistentDrops': is_project_manager, 'canvas': editorCanvas });
				});
				OnEditorExit = null;
			};
		}

		function replaceCanvas(from) {
			const out = document.createElement('canvas');
			out.id = from.id;
			out.tabIndex = from.tabIndex;
			from.parentNode.replaceChild(out, from);
			lastScale = 0;
			return out;
		}
		function InstallAndRunGame(zip) {

			showTab('status');
			editor = new Engine(editorConfig);
			editor.init('godot.editor').then(function () {
				if (zip) {
					editor.copyToFS('/tmp/preload.zip', zip);
				}
				showTab('editor');
				const args = ['--project-manager', '--single-window'];
				if (video_driver) {
					args.push('--rendering-driver', video_driver);
				}
				editor.start({ 'args': args, 'persistentDrops': true }).then(function () {
					setStatusMode('hidden');
					initializing = false;
				});
			}).catch(null);
		}
	</script>
</body>

</html>