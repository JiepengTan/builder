<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport"
		content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
	<title>Godot Engine Web Editor (4.2.2.stable.custom_build)</title>
	<style>
		*:focus {
			outline: none;
			background-color: black;
		}

		#canvas,
		#gameCanvas {
			display: block;
			margin: 0;
			color: white;
		}
	</style>
</head>

<body>
	<div id="tabs">
		<div id="tab-loader">
		</div>
		<div id="tab-editor" style="display: none;">
		</div>
		<div id="tab-game" style="display: none;">
			<canvas id="game-canvas" tabindex="2">
			</canvas>
		</div>
		<div id="tab-status" style="display: none;">
			<canvas id="editor-canvas" tabindex="1">
			</canvas>
		</div>
	</div>
	<script src="godot.editor.js"></script>
	<script>
		const tabs = [
			document.getElementById('tab-loader'),
			document.getElementById('tab-editor'),
			document.getElementById('tab-game'),
		];
		function showTab(name) {
			tabs.forEach(function (elem) {
				if (elem.id === `tab-${name}`) {
					elem.style.display = 'block';
					if (name === 'editor' || name === 'game') {
						const canvas = document.getElementById(`${name}-canvas`);
						canvas.focus();
					}
				} else {
					elem.style.display = 'none';
				}
			});
		}

		window.addEventListener('load', () => {
			if ('serviceWorker' in navigator) {
				navigator.serviceWorker.register('service.worker.js').then(function (reg) {
					if (reg.waiting) {
						notifyUpdate(reg.waiting);
					}
					reg.addEventListener('updatefound', function () {
						const update = reg.installing;
						update.addEventListener('statechange', function () {
							if (update.state === 'installed') {
								// It's a new install, claim and perform aggressive caching.
								if (!reg.active) {
									update.postMessage('claim');
								} else {
									notifyUpdate(update);
								}
							}
						});
					});
				});
			}

			InstallProject();
		});


		let editor = null;
		let game = null;
		const persistentPaths = ['/home/web_user'];

		let editorCanvas = document.getElementById('editor-canvas');
		let gameCanvas = document.getElementById('game-canvas');
		let exitFunc = null
		let editorConfig = {
			'unloadAfterInit': false,
			'canvas': editorCanvas,
			'canvasResizePolicy': 0,
			'persistentPaths': persistentPaths,
			'onExecute': function (args) {
				console.log("onExecute  ", args)
			},
			'onExit': function () {
				if (exitFunc) {
					exitFunc()
				}
			}
		};
		async function InstallProject() {
			const zipResp = fetch('/game.zip')
			const zipData = await (await (zipResp)).arrayBuffer()
			console.log("Load data succ 7", zipData)
			showTab('status');
			editor = new Engine(editorConfig);
			exitFunc = ImportProject
			editor.init('godot.editor').then(function () {
				editor.copyToFS('/tmp/preload.zip', zipData);
				const args = ['--project-manager', '--single-window'];
				editor.start({ 'args': args, 'persistentDrops': true });
			});
		}

		function ImportProject() {
			const args = [
				"--path",
				"/home/web_user/Preload",
				"--single-window",
				"--headless",
				"--editor",
				"--quit-after",
				"30"
			]
			console.log("ImportProject ", args)
			exitFunc = RunGame
			editor.init().then(function () {
				editor.start({ 'args': args, 'persistentDrops': false, 'canvas': editorCanvas });
			});
		}


		function RunGame() {
			const args = [
				"--path",
				"/home/web_user/Preload",
				"--editor-pid",
				"0",
				"res://main.tscn"
			]
			const gameConfig = {
				'persistentPaths': persistentPaths,
				'unloadAfterInit': false,
				'canvas': gameCanvas,
				'canvasResizePolicy': 1,
				'onExit': function () {
					game = null;
				},
			};
			console.log("RunGame ", args)
			if (game) {
				console.error('A game is already running. Close it first');
				return;
			}
			showTab('game');
			exitFunc = null
			game = new Engine(gameConfig);
			game.init('godot.editor').then(function () {
				game.start({ 'args': args, 'canvas': gameCanvas }).then(function () {
					gameCanvas.focus();
				});
			});
		}

	</script>
</body>

</html>